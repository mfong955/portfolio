<aside class="sidebar" id="sidebar">
  <nav class="sidebar-nav" aria-label="Site navigation">
    <ul class="nav-list nav-list--root">
      {% for item in site.data.navigation %}
        {% assign is_active = false %}
        {% if page.url == item.url %}
          {% assign is_active = true %}
        {% endif %}

        <li class="nav-item{% if is_active %} nav-item--active{% endif %} nav-item--open">
          {% if item.children %}
            <div class="nav-item-row">
              <a href="{{ item.url | relative_url }}" class="nav-link{% if is_active %} nav-link--active{% endif %}">{{ item.title }}</a>
              <button class="nav-toggle" aria-expanded="true" aria-label="Toggle {{ item.title }}">
                <svg class="nav-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
            <ul class="nav-list nav-list--children">
              {% for child in item.children %}
                {% assign child_active = false %}
                {% if page.url == child.url %}
                  {% assign child_active = true %}
                {% endif %}

                <li class="nav-item{% if child_active %} nav-item--active{% endif %} nav-item--open">
                  {% if child.children %}
                    <div class="nav-item-row">
                      <a href="{{ child.url | relative_url }}" class="nav-link{% if child_active %} nav-link--active{% endif %}">{{ child.title }}</a>
                      <button class="nav-toggle" aria-expanded="true" aria-label="Toggle {{ child.title }}">
                        <svg class="nav-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
                          <path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                    </div>
                    <ul class="nav-list nav-list--grandchildren">
                      {% for grandchild in child.children %}
                        {% assign gc_active = false %}
                        {% if page.url == grandchild.url %}
                          {% assign gc_active = true %}
                        {% endif %}
                        <li class="nav-item{% if gc_active %} nav-item--active{% endif %}">
                          <a href="{{ grandchild.url | relative_url }}" class="nav-link{% if gc_active %} nav-link--active{% endif %}">{{ grandchild.title }}</a>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <a href="{{ child.url | relative_url }}" class="nav-link{% if child_active %} nav-link--active{% endif %}">{{ child.title }}</a>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <a href="{{ item.url | relative_url }}" class="nav-link{% if is_active %} nav-link--active{% endif %}">{{ item.title }}</a>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </nav>
</aside>

<script>
  // Storage key for persisting collapsed state (items user explicitly closed)
  var STORAGE_KEY = 'sidebar-collapsed-items';

  // Get collapsed items from localStorage
  function getCollapsedItems() {
    try {
      var stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch (e) {
      return [];
    }
  }

  // Save collapsed items to localStorage
  function saveCollapsedItems(items) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    } catch (e) {
      // localStorage not available
    }
  }

  // Get a unique identifier for a nav item based on its link text
  function getNavItemId(item) {
    var link = item.querySelector('.nav-link');
    return link ? link.textContent.trim() : null;
  }

  // Helper function to toggle nav item expansion
  function toggleNavItem(item, saveState) {
    var childList = item.querySelector('.nav-list--children, .nav-list--grandchildren');
    var toggle = item.querySelector('.nav-toggle');
    if (!childList) return;

    var itemId = getNavItemId(item);
    var isHidden = childList.hasAttribute('hidden');
    
    if (isHidden) {
      // Opening: remove from collapsed list
      childList.removeAttribute('hidden');
      if (toggle) toggle.setAttribute('aria-expanded', 'true');
      item.classList.add('nav-item--open');
      
      if (saveState !== false && itemId) {
        var collapsed = getCollapsedItems();
        var index = collapsed.indexOf(itemId);
        if (index > -1) {
          collapsed.splice(index, 1);
          saveCollapsedItems(collapsed);
        }
      }
    } else {
      // Closing: add to collapsed list
      childList.setAttribute('hidden', '');
      if (toggle) toggle.setAttribute('aria-expanded', 'false');
      item.classList.remove('nav-item--open');
      
      if (saveState !== false && itemId) {
        var collapsed = getCollapsedItems();
        if (collapsed.indexOf(itemId) === -1) {
          collapsed.push(itemId);
          saveCollapsedItems(collapsed);
        }
      }
    }
  }

  // Apply collapsed state from localStorage on page load
  // By default everything is open; we only collapse items the user explicitly closed
  function applyCollapsedState() {
    var collapsed = getCollapsedItems();
    if (collapsed.length === 0) return;

    document.querySelectorAll('.nav-item').forEach(function(item) {
      var itemId = getNavItemId(item);
      var childList = item.querySelector('.nav-list--children, .nav-list--grandchildren');
      
      if (itemId && childList && collapsed.indexOf(itemId) > -1) {
        // This item should be collapsed
        childList.setAttribute('hidden', '');
        var toggle = item.querySelector('.nav-toggle');
        if (toggle) toggle.setAttribute('aria-expanded', 'false');
        item.classList.remove('nav-item--open');
      }
    });
  }

  // Apply collapsed state on page load
  applyCollapsedState();

  // Sidebar toggle for expand/collapse (chevron button)
  document.querySelectorAll('.nav-toggle').forEach(function(toggle) {
    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      var item = this.closest('.nav-item');
      toggleNavItem(item);
    });
  });

  // Nav links with children navigate to their URL normally.
  // The chevron button handles expand/collapse separately.

  // Mobile sidebar toggle
  var sidebarToggle = document.getElementById('sidebar-toggle');
  var sidebar = document.getElementById('sidebar');
  var sidebarOverlay = document.getElementById('sidebar-overlay');

  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', function() {
      sidebar.classList.toggle('sidebar--open');
      if (sidebarOverlay) sidebarOverlay.classList.toggle('sidebar-overlay--visible');
      var isOpen = sidebar.classList.contains('sidebar--open');
      this.setAttribute('aria-expanded', isOpen);
    });
  }

  if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', function() {
      sidebar.classList.remove('sidebar--open');
      this.classList.remove('sidebar-overlay--visible');
      if (sidebarToggle) sidebarToggle.setAttribute('aria-expanded', 'false');
    });
  }
</script>
